# Purpose: Test environment for armv7 filter binary
# Requires: docker buildx with QEMU for ARM32 emulation

FROM --platform=linux/arm/v7 debian:bullseye-slim

# Install CUPS runtime dependencies and raster generation tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    cups \
    cups-filters \
    cups-client \
    libcups2 \
    libcupsimage2 \
    cups-ppdc \
    python3 \
    file \
    gzip \
    ghostscript \
    imagemagick \
    && rm -rf /var/lib/apt/lists/*

# Create directories
RUN mkdir -p /opt/test/fixtures /opt/test/output /usr/lib/cups/filter /opt/test/ppd

WORKDIR /opt/test

# Copy and decompress filter binary
COPY filters/armv7/cups_2.2.10/raster-tspl.gz /tmp/
RUN gunzip /tmp/raster-tspl.gz && \
    mv /tmp/raster-tspl /usr/lib/cups/filter/raster-tspl && \
    chmod 755 /usr/lib/cups/filter/raster-tspl

# Copy PPD files
COPY ppd/ /opt/test/ppd/

# Copy DRV files
COPY drv/ /opt/test/drv/

# Copy test scripts
COPY test/scripts/ /opt/test/scripts/
COPY test/fixtures/ /opt/test/fixtures/
COPY test/lib/ /opt/test/lib/

# Verify filter is executable
RUN file /usr/lib/cups/filter/raster-tspl

ENTRYPOINT ["/opt/test/scripts/run-tests.sh"]
